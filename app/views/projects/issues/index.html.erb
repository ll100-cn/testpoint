<div class="page-header justify-content-between">
  <h2><%= title(page_i18n :index, model_name: h(@issues)) %>（<%= @project.name %>）</h2>

  <%= form_tag url_for(action: :index), method: :get, class: "ms-auto" do |f| %>
    <div class="input-group">
      <%= search_field_tag :keyword, @keyword, placeholder: "搜索标题", class: "form-control" %>
      <%= hidden_field_tag :filter, 'all' %>
      <%= submit_tag "搜索", class: "btn btn-primary" %>
    </div>
  <% end %>

  <div class="actions ms-3">
    <%= new_button [@project, :issue] if can? :new, Issue %>
  </div>
</div>

<% issues_scope = @project.issues %>
<div class="nav-scroll mb-n1px position-relative zindex-999">
  <ul class="nav nav-tabs">
   <%= fume_nav @filter do |n| %>
     <li class="nav-item">
       <%= n.link_to "all", url_for(action: :index, filter: 'all'), class: "nav-item nav-link" do %>
         全部 (<%= @issue_filter_state_counts.values.sum %>)
       <% end %>
     </li>
     <% Issue.filter_states_options.each do |(code, attrs)| %>

      <li class="nav-item">
        <%= n.link_to code, url_for(action: :index, filter: code), class: "nav-item nav-link" do %>
          <%= attrs[:text] %> (<%= issue_filter_state_count(code, @issue_filter_state_counts) %>)
        <% end %>
      </li>

     <% end %>
    <% end %>
  </ul>
</div>

<div class="card rounded-top-left-0">
  <div class="card-body">

    <button class="btn btn-secondary btn-block d-md-none mb-3" type="button" data-bs-toggle="collapse" data-target="#issueFilterCollapse">
      过滤条件
    </button>

    <%= bootstrap_inline_form_for @issue_searcher, as: :search, url: url_for(action: :index), method: :get, html: { class: "simple_form row mb-0 auto-submit" } do |f| %>

      <% category_options = @project.categories.where(id: @issue_searcher.categories_counts.keys).map do |category| %>
        <% ["#{category.name} (#{@issue_searcher.categories_counts[category.id].to_i})", category.id, data: { content: [
                category_badge_tag(category, nil, class: "badge-circle me-2"),
                category.name,
                "(#{@issue_searcher.categories_counts[category.id].to_i})"
              ].join(" ") } ] %>
      <% end %>

      <%= f.input :category_id_eq, collection: category_options, input_html: { class: "selectpicker" }, include_blank: "全部" %>

      <% milestone_options = @project.milestones.where(id: @issue_searcher.milestone_counts.keys).ranked.map do |milestone| %>
        <% ["#{milestone.title} (#{@issue_searcher.milestone_counts[milestone.id].to_i})", milestone.id] %>
      <% end %>
      <%= f.input :milestone_id_eq, collection: milestone_options, input_html: { class: "selectpicker" }, include_blank: "任意" %>
    
      <% assignee_options = @project.members.where(id: @issue_searcher.assignee_counts.keys).ranked.map do |member| %>
        <% ["#{member.name} (#{@issue_searcher.assignee_counts[member.id].to_i})", member.id] %>
      <% end %>
      <%= f.input :assignee_id_eq, collection: assignee_options, input_html: { class: "selectpicker" }, include_blank: "任意" %>

      <% creator_options = @project.members.where(id: @issue_searcher.creator_counts.keys).ranked.map do |member| %>
        <% ["#{member.name} (#{@issue_searcher.creator_counts[member.id].to_i})", member.id] %>
      <% end %>
      <%= f.input :creator_id_eq, collection: creator_options, input_html: { class: "selectpicker" }, include_blank: "任意" %>

      <%= f.input :task_id_is, collection: [["案例问题", "not_null"], ["非案例问题", "null"]], input_html: { class: "selectpicker" }, include_blank: "所有" %>
  
      <%= hidden_field_tag :filter, @filter %>
      <%= hidden_field_tag :keyword, @keyword %>
    <% end %>

    <table class="table d-none d-md-table">
      <colgroup>
        <col width="5%">
        <col width="20%">
        <col width="10%">
        <col width="8%">
        <col width="10%">
        <col width="10%">
        <col width="10%">
      </colgroup>
      <thead>
        <tr>
          <th><%= sort_link(@q, :id)%></th>
          <th><%= sort_link(@q, :title)%></th>
          <th><%= sort_link(@q, :category_id)%></th>
          <th><%= sort_link(@q, :state)%></th>
          <th><%= sort_link(@q, :milestone_id)%></th>
          <th><%= sort_link(@q, :creator_id)%></th>
          <th><%= sort_link(@q, :assignee_id)%></th>
        </tr>
      </thead>
      <tbody>
        <% @issues.each do |issue| %>
          <tr class="<%= 'block-discard' if issue.state.archived? %>">
            <td><%= issue.id %></td>
            <td>
              <%= link_to issue.title_with_priority, [@project, issue] %>
            </td>
            <td>
              <%= category_badge_tag(issue.category, issue.category.name) if issue.category %>
            </td>
            <td>
              <%= badge_issue_state(issue.state) %>
            </td>
            <td>
              <% if issue.milestone %>
                <%= issue.milestone.title %>
              <% end %>
            </td>
            <td><%= issue.creator.name %></td>
            <td><%= issue.assignee&.name %></td>
            <% if @task %>
              <td>
                <%= render "relate_issue", project: @project, plan: @task.plan, task: @task, issue: issue %>
              </td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>

    <div class="list-group list-group-flush d-flex d-md-none">
      <% @issues.each do |issue| %>
          <%= link_to [@project, issue], class: "list-group-item list-group-item-action" do %>
            <div class="d-flex justify-content-between">
              <h4 class="mb-1"><%= issue.title_with_priority.truncate(12) %></h4>
              <%= badge_issue_state(issue.state) %>
            </div>
            <p class="mb-3">
              <small>
                <%= category_badge_tag(issue.category, issue.category.name) if issue.category %>
              </small>
            </p>
            <div class="d-flex justify-content-between text-muted">
              <small>
                <b><%= issue.creator.name %></b> 创建于 <%= time_ago_in_words(issue.created_at) %>前
              </small>
              <small>
                <% if issue.assignee %>
                  <b><%= issue.assignee&.name %></b> 已受理
                <% elsif issue.state.confirmed? %>
                  尚未受理
                <% end %>
              </small>
            </div>
          <% end %>
      <% end %>
    </div>
  </div>

  <nav class="table-pagination">
    <%= paginate @issues %>
  </nav>
</div>
