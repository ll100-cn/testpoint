<div class="page-header justify-content-between">
  <h2><%= title(page_i18n :index, model_name: h(@issues)) %>（<%= @project.name %>）</h2>

  <%= search_form_for @q, url: project_issues_path(@project), class: "ms-auto" do |f| %>
    <div class="input-group">
      <%= f.search_field :title_cont, placeholder: "搜索标题", class: "form-control" %>
      <%= f.submit "搜索", class: "btn btn-primary" %>
    </div>
  <% end %>

  <div class="actions ms-3">
    <%= new_button [@project, :issue] if can? :new, Issue %>
  </div>
</div>

<% issues_scope = @project.issues %>
<div class="nav-scroll">
  <ul class="nav nav-tabs">
   <%= fume_nav @filter do |n| %>
     <li class="nav-item">
       <%= n.link_to "all", url_for(action: :index), class: "nav-item nav-link" do %>
         全部 (<%= @issue_state_counts.values.sum %>)
       <% end %>
     </li>
     <% Issue.state.options.each do |(text, value)| %>

      <li class="nav-item">
        <%= n.link_to value, url_for(action: :index, filter: value), class: "nav-item nav-link" do %>
          <%= text %> (<%= @issue_state_counts[value].to_i %>)
        <% end %>
      </li>

     <% end %>
    <% end %>
  </ul>
</div>

<div class="card border-top-0">
  <div class="card-body">

    <button class="btn btn-secondary btn-block d-md-none mb-3" type="button" data-bs-toggle="collapse" data-target="#issueFilterCollapse">
      过滤条件
    </button>


    <div class="collapse d-md-flex mx-0 mb-3 align-items-center" id="issueFilterCollapse">
      <% issue_scope = @issues_scope %>
      <span class="me-2 mb-1"><%=h Issue, :label_ids %></span>

      <% label = Label.where(id: @issue_searcher.label_id_eq).take %>

      <%= fume_nav label&.id do |n| %>
        <div class="dropdown me-2 mb-1">

          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
            <%= label_badge_tag label, nil, class: "badge-circle me-2" %><%= label&.name || page_i18n(:all) %>
          </button>

          <div class="dropdown-menu">
            <%= n.link_to nil, current_url(q: { label_id_eq: nil }), class: "dropdown-item" do %>
              <%= label_badge_tag nil, nil, class: "badge-circle me-2" %><%= page_i18n(:all) %>
            <% end %>
            <% @project.labels.each do |label| %>
              <%= n.link_to label.id, current_url(q: { label_id_eq: label.id }), class: "dropdown-item" do %>
                <%= label_badge_tag label, nil, class: "badge-circle me-2" %>
                <%= label.name %>
                <%= "(#{@issue_searcher.labels_counts[label.id].to_i})" %>
              <% end %>
            <% end %>
            <% if can? :index, Label %>
              <div class="dropdown-divider"></div>
              <%= link_to page_i18n(:index, model_name: h(Label)), "javascript:void(0)", class: "dropdown-item", data: { bs_toggle: "modal", bs_target: "#applicationModal", url: project_labels_path(@project, ok_url: request.fullpath) } %>
            <% end %>
          </div>
        </div>
      <% end %>

      <span class="me-2 mb-1"><%=h Issue, :milestone_id %></span>
      <% milestone = Milestone.where(id: @issue_searcher.milestone_id_eq).take %>
      <%= fume_nav milestone&.id do |n| %>
        <div class="dropdown me-2 mb-1">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
            <%= milestone&.title || page_i18n(:all) %>
          </button>

          <div class="dropdown-menu" style="max-height: 300px; overflow-y: auto;">

            <%= n.link_to nil, page_i18n(:all), current_url(q: { milestone_id_eq: nil }), class: "dropdown-item" %>

            <% @project.milestones.where(id: @issue_searcher.milestone_counts.keys).ranked.each do |milestone| %>
              <%= n.link_to milestone.id, current_url(q: { milestone_id_eq: milestone.id }), class: "dropdown-item" do %>
                <%= milestone.title %> 
                <%= "(#{@issue_searcher.milestone_counts[milestone.id].to_i})" %>
              <% end %>
            <% end %>

          </div>
        </div>
      <% end %>

      <span class="me-2 mb-1"><%=h Issue, :assignee_id %></span>
      <% assignee = @project.members.where(id: @issue_searcher.assignee_id_eq).take %>
      <%= fume_nav assignee&.id do |n| %>
        <div class="dropdown me-2 mb-1">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
            <%= assignee&.name || page_i18n(:all) %>
          </button>
          <div class="dropdown-menu" style="max-height: 300px; overflow-y: auto;">
            <%= n.link_to nil, page_i18n(:all), current_url(q: { assignee_id_eq: nil }), class: "dropdown-item" %>
            <% @project.members.where(id: @issue_searcher.assignee_counts.keys).ranked.each do |assignee| %>
              <%= n.link_to assignee.id, current_url(q: { assignee_id_eq: assignee.id }), class: "dropdown-item" do %>
                <%= assignee.name %>
                <%= "(#{@issue_searcher.assignee_counts[assignee.id].to_i})" %>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>

      <span class="me-2 mb-1"><%=h Issue, :creator_id %></span>
      <% creator = @project.members.where(id: @issue_searcher.creator_id_eq).take %>
      <%= fume_nav creator&.id do |n| %>
        <div class="dropdown me-2 mb-1">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
            <%= creator&.name || page_i18n(:all) %>
          </button>
          <div class="dropdown-menu" style="max-height: 300px; overflow-y: auto;">
            <%= n.link_to nil, page_i18n(:all), current_url(q: { creator_id_eq: nil }), class: "dropdown-item" %>
            <% @project.members.where(id: @issue_searcher.creator_counts.keys).ranked.each do |creator| %>
              <%= n.link_to creator.id, current_url(q: { creator_id_eq: creator.id }), class: "dropdown-item" do %>
                <%= creator.name %>
                <%= "(#{@issue_searcher.creator_counts[creator.id].to_i})" %>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>

      <span class="me-2 mb-1">问题来源</span>
      <%= fume_nav @issue_searcher.task_id_is do |n| %>
        <div class="dropdown me-auto mb-1">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
            <%= @issue_searcher.task_id_is.presence || "所有" %>
          </button>
          <div class="dropdown-menu" style="max-height: 300px; overflow-y: auto;">
            <%= n.link_to nil, current_url(q: { task_id_is: nil }), class: "dropdown-item" do %>
              所有
            <% end %>
            <%= n.link_to "not_null", current_url(q: { task_id_is: "not_null" }), class: "dropdown-item" do %>
              来自测试案例
            <% end %>
            <%= n.link_to "null", current_url(q: { task_id_is: "null" }), class: "dropdown-item" do %>
              隐藏来自测试
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <table class="table d-none d-md-table">
      <colgroup>
        <col width="5%">
        <col width="20%">
        <col width="10%">
        <col width="8%">
        <col width="10%">
        <col width="10%">
        <col width="10%">
      </colgroup>
      <thead>
        <tr>
          <th><%= sort_link(@q, :id)%></th>
          <th><%= sort_link(@q, :title)%></th>
          <th><%= sort_link(@q, :label_ids)%></th>
          <th><%= sort_link(@q, :state)%></th>
          <th><%= sort_link(@q, :milestone_id)%></th>
          <th><%= sort_link(@q, :creator_id)%></th>
          <th><%= sort_link(@q, :assignee_id)%></th>
        </tr>
      </thead>
      <tbody>
        <% @issues.each do |issue| %>
          <tr class="<%= 'block-discard' if issue.state.resolved? %>">
            <td><%= issue.id %></td>
            <td>
              <%= link_to issue.title_with_priority, [@project, issue] %>
            </td>
            <td>
              <% issue.labels.each do |label| %>
                <%= label_badge_tag(label, label.name) %>
              <% end %>
            </td>
            <td>
              <span class="text-issue-<%= issue.state %>">
                <%= issue.state.text %>
              </span>
            </td>
            <td>
              <% if issue.milestone %>
                <%= issue.milestone.title %>
              <% end %>
            </td>
            <td><%= issue.creator.name %></td>
            <td><%= issue.assignee&.name %></td>
            <% if @task %>
              <td>
                <%= render "relate_issue", project: @project, plan: @task.plan, task: @task, issue: issue %>
              </td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>

    <div class="list-group list-group-flush d-flex d-md-none">
      <% @issues.each do |issue| %>
          <%= link_to [@project, issue], class: "list-group-item list-group-item-action" do %>
            <div class="d-flex justify-content-between">
              <h4 class="mb-1"><%= issue.title_with_priority.truncate(12) %></h4>
              <span class="text-issue-<%= issue.state %>">
                <%= issue.state.text %>
              </span>
            </div>
            <p class="mb-3">
              <small>
                <% issue.labels.each do |label| %>
                  <%= label_badge_tag(label, label.name) %>
                <% end %>
              </small>
            </p>
            <div class="d-flex justify-content-between text-muted">
              <small>
                <b><%= issue.creator.name %></b> 创建于 <%= time_ago_in_words(issue.created_at) %>前
              </small>
              <small>
                <% if issue.assignee %>
                  <b><%= issue.assignee&.name %></b> 已受理
                <% elsif issue.state.confirmed? %>
                  尚未受理
                <% end %>
              </small>
            </div>
          <% end %>
      <% end %>
    </div>
  </div>

  <nav class="table-pagination">
    <%= paginate @issues %>
  </nav>
</div>
