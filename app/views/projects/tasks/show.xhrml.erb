<div class="modal-header">
  <h5 class="modal-title">
    测试指南
  </h5>
  <% if @task.test_case_changed_after_finish? %>
    <small class="text-danger ms-3">当前内容为测试完成时的快照，该案例的测试指南已被更新</small>
  <% end %>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
  <h5><%= @task.finished? ? @task.test_case_snapshot.title : @task.test_case.title %></h5>

  <% @task.content ||= @task.test_case_snapshot.content %>
  <%= content_tag :small, "该测试用例无详细信息", class: "text-muted" if @task.content.nil? %>

  <%= form_for @task, url: [@project, @plan, @task], html: { data: { remote: true, type: :xhrml, target: ".modal-content"  }, class: "auto-submit" } do |f| %>
    <%= f.text_area(:content, data: { controller: "markdown" }, class: "d-none") %>
  <% end %>

  <hr class="mt-5">

  <p class="d-flex justify-content-between">
    <span><%= task_state_with_icon(@task.state) %></span>
    <small class="text-muted"><%=l @task.updated_at, format: :short %>
  </p>

  <div class="mb-3">
    <% if !@task.issues.empty? %>
      <p class="text-muted mb-0">已关联的工单:</p>
      <% @task.issues.each do |issue| %>
        <p class="mb-0">
          <%= link_to "##{issue.id}#{issue.title}", [@project, issue] %>
        </p>
      <% end %>
    <% end %>
  </div>

  <% if @task.message || !@task.attachments.empty? %>
    <p class="mb-0 text-muted">附加的错误信息:</p>
      <%= render "shared/page_content.html.erb", content: @task.message %>
      <%= render "shared/attachments_box.html.erb", attachmentable: @task %>
  <% end %>
</div>
<div class="modal-footer">
  <% if @task.state.pending? %>
    <%= link_to "全部通过",
                [@project, @plan, @task, task: { state: :pass, test_case_version: Time.current }],
                method: :patch,
                class: "btn btn-success", data: { remote: true, type: :xhrml, target: ".modal-content" } %>
    <%= link_to "不通过, 创建工单",
                [:edit, @project, @plan, @task, task: { state: :failure, test_case_version: Time.current }],
                class: "btn btn-danger", data: { remote: true, type: :xhrml, target: ".modal-content" } %>
  <% else %>
    <%= link_to "撤销当前的测试结果", [@project, @plan, @task, task: { state: :pending, test_case_version: Time.current }],
                method: :patch,
                data: { remote: true, type: :xhrml, target: ".modal-content" } %>
  <% end %>
</div>
